#include <windows.h>

#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>

static bool g_running;

static bool pump_messages(void) {
	MSG msg;
	while (PeekMessageA(&msg, 0, 0, 0, PM_REMOVE)) {
		if (msg.message == WM_QUIT) {
			return false;
		}
		TranslateMessage(&msg);
		DispatchMessageA(&msg);
	}
	return true;
}

// Timing
typedef struct Win32Timer {
	int64_t perf_freq;
	int64_t last_counter;
} Win32Timer;

static void timer_init(Win32Timer* t) {
	LARGE_INTEGER freq;
	QueryPerformanceFrequency(&freq);
	t->perf_freq = (int64_t)freq.QuadPart;

	LARGE_INTEGER counter;
	QueryPerformanceCounter(&counter);
	t->last_counter = (int64_t)counter.QuadPart;
}

static float timer_tick_seconds(Win32Timer* t) {
	LARGE_INTEGER counter;
	QueryPerformanceCounter(&counter);

	int64_t now = (int64_t)counter.QuadPart;
	int64_t delta = now - t->last_counter;
	t->last_counter = now;

	double seconds = 0.0;
	if (t->perf_freq > 0) {
		seconds = (double)delta / (double)t->perf_freq;
	}

	if (seconds < 0.0) {
		seconds = 0.0;
	}

	if (seconds > 0.05) {
		seconds = 0.05;
	}

	return (float)seconds;
}

// Frame Work
static void do_frame_work(HWND hwnd, float dt_seconds) {
	static float title_timer = 0.0f;
	title_timer += dt_seconds;

	if (title_timer >= 0.25f) {
		title_timer = 0.0f;

		float fps = 0.0f;
		if (dt_seconds > 0.0f) {
			fps = 1.0f / dt_seconds;
		}

		char buffer[256];

		snprintf(buffer, sizeof(buffer), "Snake - dt: %.4f  fps: %.1f", dt_seconds, fps);
		SetWindowTextA(hwnd, buffer);
	}
}

static LRESULT CALLBACK wnd_proc(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam) {
	switch (msg) {
		case WM_CLOSE: {
			g_running = false;
			return 0;
		}

		case WM_DESTROY: {
			g_running = false;
			PostQuitMessage(0);
			return 0;
		}

		default: {
			return DefWindowProcA(hwnd, msg, wParam, lParam);
		} break;
	}
}

int WINAPI WinMain(HINSTANCE instance, HINSTANCE prev_instance, LPSTR cmd_line, int show_code) {
	(void)prev_instance;
	(void)cmd_line;
	(void)show_code;

	WNDCLASSA wc = { 0 };
	wc.style = CS_OWNDC | CS_HREDRAW | CS_VREDRAW;
	wc.lpfnWndProc = wnd_proc;
	wc.hInstance = instance;
	wc.lpszClassName = "MySnakeGameWin32MemAlloc";
	
	RegisterClassA(&wc);

	HWND hwnd = CreateWindowExA(
		0, 
		wc.lpszClassName,
		"My Snake Game Win32 Mem Alloc",
		WS_OVERLAPPEDWINDOW | WS_VISIBLE,
		CW_USEDEFAULT, CW_USEDEFAULT,
		900, 700,
		0, 0, instance, 0
	);

	Win32Timer timer;
	timer_init(&timer);

	g_running = true;
	while (g_running) {
		if (!pump_messages()) {
			g_running = false;
			break;
		}

		float dt_seconds = timer_tick_seconds(&timer);

		do_frame_work(hwnd, dt_seconds);

		Sleep(1);
	}

	return 0;
}

